<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.personalizedlearning.system.mapper.StudentCourseMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.personalizedlearning.system.entity.StudentCourse">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="student_id" property="studentId" jdbcType="BIGINT"/>
        <result column="course_id" property="courseId" jdbcType="BIGINT"/>
        <result column="enroll_date" property="enrollDate" jdbcType="TIMESTAMP"/>
        <result column="is_active" property="isActive" jdbcType="BOOLEAN"/>
    </resultMap>

    <!-- 插入学生课程关系 -->
    <insert id="insert" parameterType="com.personalizedlearning.system.entity.StudentCourse">
        INSERT INTO student_courses (student_id, course_id, enroll_date, is_active)
        VALUES (#{studentId}, #{courseId}, #{enrollDate}, #{isActive})
    </insert>

    <!-- 更新学生课程关系 -->
    <update id="update" parameterType="com.personalizedlearning.system.entity.StudentCourse">
        UPDATE student_courses
        SET student_id = #{studentId},
            course_id = #{courseId},
            enroll_date = #{enrollDate},
            is_active = #{isActive}
        WHERE id = #{id}
    </update>

    <!-- 删除学生课程关系 -->
    <delete id="delete" parameterType="java.lang.Long">
        DELETE FROM student_courses WHERE id = #{id}
    </delete>

    <!-- 根据ID查询学生课程关系 -->
    <select id="findById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM student_courses WHERE id = #{id}
    </select>

    <!-- 查询所有学生课程关系 -->
    <select id="findAll" resultMap="BaseResultMap">
        SELECT * FROM student_courses
    </select>

    <!-- 根据学生ID查询课程 -->
    <select id="findCoursesByStudentId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM student_courses WHERE student_id = #{studentId}
    </select>

    <!-- 根据课程ID查询学生 -->
    <select id="findStudentsByCourseId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM student_courses WHERE course_id = #{courseId}
    </select>

    <!-- 根据学生和课程ID查询关系 -->
    <select id="findByStudentAndCourse" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM student_courses
        WHERE student_id = #{studentId} AND course_id = #{courseId}
    </select>

    <!-- 检查学生是否已报名课程 -->
    <select id="isEnrolled" parameterType="map" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM student_courses
        WHERE student_id = #{studentId} AND course_id = #{courseId} AND is_active = TRUE
    </select>

    <!-- 获取学生课程总数 -->
    <select id="countStudentCourses" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses WHERE student_id = #{studentId}
    </select>

    <!-- 获取活跃学生课程数 -->
    <select id="countActiveStudentCourses" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses WHERE student_id = #{studentId} AND is_active = TRUE
    </select>

    <!-- 获取课程学生总数 -->
    <select id="countCourseStudents" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses WHERE course_id = #{courseId}
    </select>

    <!-- 获取活跃课程学生数 -->
    <select id="countActiveCourseStudents" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses WHERE course_id = #{courseId} AND is_active = TRUE
    </select>

    <!-- 获取总报名人数 -->
    <select id="getTotalEnrollments" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses
    </select>

    <!-- 获取总活跃报名人数 -->
    <select id="getTotalActiveEnrollments" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses WHERE is_active = TRUE
    </select>

    <!-- 获取日期范围内的报名 -->
    <select id="findByEnrollDateRange" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM student_courses
        WHERE enroll_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY enroll_date DESC
    </select>

    <!-- 分页查询学生课程关系 -->
    <select id="findByPage" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM student_courses LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 查询学生课程关系总数 -->
    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM student_courses
    </select>
</mapper>