<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.personalizedlearning.system.mapper.AssignmentSubmissionMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.personalizedlearning.system.entity.AssignmentSubmission">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="assignment_id" property="assignmentId" jdbcType="BIGINT"/>
        <result column="student_id" property="studentId" jdbcType="BIGINT"/>
        <result column="submit_time" property="submitTime" jdbcType="TIMESTAMP"/>
        <result column="file_path" property="filePath" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="score" property="score" jdbcType="DECIMAL"/>
        <result column="feedback" property="feedback" jdbcType="LONGVARCHAR"/>
    </resultMap>

    <!-- 插入作业提交 -->
    <insert id="insert" parameterType="com.personalizedlearning.system.entity.AssignmentSubmission">
        INSERT INTO assignment_submissions (assignment_id, student_id, submit_time, file_path, status, score, feedback)
        VALUES (#{assignmentId}, #{studentId}, #{submitTime}, #{filePath}, #{status}, #{score}, #{feedback})
    </insert>

    <!-- 更新作业提交 -->
    <update id="update" parameterType="com.personalizedlearning.system.entity.AssignmentSubmission">
        UPDATE assignment_submissions
        SET assignment_id = #{assignmentId},
            student_id = #{studentId},
            submit_time = #{submitTime},
            file_path = #{filePath},
            status = #{status},
            score = #{score},
            feedback = #{feedback}
        WHERE id = #{id}
    </update>

    <!-- 删除作业提交 -->
    <delete id="delete" parameterType="java.lang.Long">
        DELETE FROM assignment_submissions WHERE id = #{id}
    </delete>

    <!-- 根据ID查询作业提交 -->
    <select id="findById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions WHERE id = #{id}
    </select>

    <!-- 查询所有作业提交 -->
    <select id="findAll" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions
    </select>

    <!-- 根据作业ID查询提交 -->
    <select id="findByAssignmentId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions WHERE assignment_id = #{assignmentId}
    </select>

    <!-- 根据学生ID查询提交 -->
    <select id="findByStudentId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions WHERE student_id = #{studentId}
    </select>

    <!-- 根据学生和作业ID查询提交 -->
    <select id="findByStudentAndAssignment" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions
        WHERE student_id = #{studentId} AND assignment_id = #{assignmentId}
    </select>

    <!-- 查询未评分的提交 -->
    <select id="findUngradedSubmissions" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions WHERE status = 'submitted' OR status = 'late'
    </select>

    <!-- 根据提交状态查询 -->
    <select id="findByStatus" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions WHERE status = #{status}
    </select>

    <!-- 查询逾期提交 -->
    <select id="findLateSubmissions" resultMap="BaseResultMap">
        SELECT s.* FROM assignment_submissions s
        JOIN assignments a ON s.assignment_id = a.id
        WHERE s.submit_time > a.deadline
    </select>

    <!-- 检查是否逾期提交 -->
    <select id="checkLateSubmission" parameterType="java.lang.Long" resultType="java.lang.Boolean">
        SELECT CASE WHEN NOW() > deadline THEN TRUE ELSE FALSE END AS is_late
        FROM assignments
        WHERE id = #{assignmentId}
    </select>

    <!-- 获取作业的学生总数 -->
    <select id="getTotalStudentsByAssignment" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT sc.student_id) FROM student_courses sc
        JOIN assignments a ON sc.course_id = a.course_id
        WHERE a.id = #{assignmentId}
    </select>

    <!-- 获取已提交作业的学生数 -->
    <select id="getSubmittedCountByAssignment" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM assignment_submissions
        WHERE assignment_id = #{assignmentId}
    </select>

    <!-- 获取逾期提交的学生数 -->
    <select id="getLateCountByAssignment" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM assignment_submissions s
        JOIN assignments a ON s.assignment_id = a.id
        WHERE s.assignment_id = #{assignmentId} AND s.submit_time > a.deadline
    </select>

    <!-- 获取作业平均分数 -->
    <select id="getAverageScoreByAssignment" parameterType="java.lang.Long" resultType="java.lang.Double">
        SELECT AVG(score) FROM assignment_submissions
        WHERE assignment_id = #{assignmentId} AND score IS NOT NULL
    </select>

    <!-- 分页查询作业提交 -->
    <select id="findByPage" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM assignment_submissions LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 查询作业提交总数 -->
    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM assignment_submissions
    </select>
</mapper>